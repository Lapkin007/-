{"ast":null,"code":"'use strict';\n\nvar _classCallCheck = require(\"E:/DW/wasai-cinema/node_modules/@babel/runtime/helpers/classCallCheck.js\").default;\n\nvar _createClass = require(\"E:/DW/wasai-cinema/node_modules/@babel/runtime/helpers/createClass.js\").default;\n\nvar _inherits = require(\"E:/DW/wasai-cinema/node_modules/@babel/runtime/helpers/inherits.js\").default;\n\nvar _createSuper = require(\"E:/DW/wasai-cinema/node_modules/@babel/runtime/helpers/createSuper.js\").default;\n\nrequire(\"core-js/modules/es.array.concat.js\");\n\nrequire(\"core-js/modules/es.array.slice.js\");\n\nrequire(\"core-js/modules/es.object.to-string.js\");\n\nrequire(\"core-js/modules/es.typed-array.uint8-array.js\");\n\nrequire(\"core-js/modules/es.typed-array.at.js\");\n\nrequire(\"core-js/modules/es.typed-array.copy-within.js\");\n\nrequire(\"core-js/modules/es.typed-array.every.js\");\n\nrequire(\"core-js/modules/es.typed-array.fill.js\");\n\nrequire(\"core-js/modules/es.typed-array.filter.js\");\n\nrequire(\"core-js/modules/es.typed-array.find.js\");\n\nrequire(\"core-js/modules/es.typed-array.find-index.js\");\n\nrequire(\"core-js/modules/es.typed-array.for-each.js\");\n\nrequire(\"core-js/modules/es.typed-array.includes.js\");\n\nrequire(\"core-js/modules/es.typed-array.index-of.js\");\n\nrequire(\"core-js/modules/es.typed-array.iterator.js\");\n\nrequire(\"core-js/modules/es.typed-array.join.js\");\n\nrequire(\"core-js/modules/es.typed-array.last-index-of.js\");\n\nrequire(\"core-js/modules/es.typed-array.map.js\");\n\nrequire(\"core-js/modules/es.typed-array.reduce.js\");\n\nrequire(\"core-js/modules/es.typed-array.reduce-right.js\");\n\nrequire(\"core-js/modules/es.typed-array.reverse.js\");\n\nrequire(\"core-js/modules/es.typed-array.set.js\");\n\nrequire(\"core-js/modules/es.typed-array.slice.js\");\n\nrequire(\"core-js/modules/es.typed-array.some.js\");\n\nrequire(\"core-js/modules/es.typed-array.sort.js\");\n\nrequire(\"core-js/modules/es.typed-array.subarray.js\");\n\nrequire(\"core-js/modules/es.typed-array.to-locale-string.js\");\n\nrequire(\"core-js/modules/es.typed-array.to-string.js\");\n\nrequire(\"core-js/modules/es.error.cause.js\");\n\nvar _require = require('stream'),\n    Writable = _require.Writable;\n\nvar PerMessageDeflate = require('./permessage-deflate');\n\nvar _require2 = require('./constants'),\n    BINARY_TYPES = _require2.BINARY_TYPES,\n    EMPTY_BUFFER = _require2.EMPTY_BUFFER,\n    kStatusCode = _require2.kStatusCode,\n    kWebSocket = _require2.kWebSocket;\n\nvar _require3 = require('./buffer-util'),\n    concat = _require3.concat,\n    toArrayBuffer = _require3.toArrayBuffer,\n    unmask = _require3.unmask;\n\nvar _require4 = require('./validation'),\n    isValidStatusCode = _require4.isValidStatusCode,\n    isValidUTF8 = _require4.isValidUTF8;\n\nvar GET_INFO = 0;\nvar GET_PAYLOAD_LENGTH_16 = 1;\nvar GET_PAYLOAD_LENGTH_64 = 2;\nvar GET_MASK = 3;\nvar GET_DATA = 4;\nvar INFLATING = 5;\n/**\n * HyBi Receiver implementation.\n *\n * @extends Writable\n */\n\nvar Receiver = /*#__PURE__*/function (_Writable) {\n  _inherits(Receiver, _Writable);\n\n  var _super = _createSuper(Receiver);\n\n  /**\n   * Creates a Receiver instance.\n   *\n   * @param {Object} [options] Options object\n   * @param {String} [options.binaryType=nodebuffer] The type for binary data\n   * @param {Object} [options.extensions] An object containing the negotiated\n   *     extensions\n   * @param {Boolean} [options.isServer=false] Specifies whether to operate in\n   *     client or server mode\n   * @param {Number} [options.maxPayload=0] The maximum allowed message length\n   * @param {Boolean} [options.skipUTF8Validation=false] Specifies whether or\n   *     not to skip UTF-8 validation for text and close messages\n   */\n  function Receiver() {\n    var _this;\n\n    var options = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};\n\n    _classCallCheck(this, Receiver);\n\n    _this = _super.call(this);\n    _this._binaryType = options.binaryType || BINARY_TYPES[0];\n    _this._extensions = options.extensions || {};\n    _this._isServer = !!options.isServer;\n    _this._maxPayload = options.maxPayload | 0;\n    _this._skipUTF8Validation = !!options.skipUTF8Validation;\n    _this[kWebSocket] = undefined;\n    _this._bufferedBytes = 0;\n    _this._buffers = [];\n    _this._compressed = false;\n    _this._payloadLength = 0;\n    _this._mask = undefined;\n    _this._fragmented = 0;\n    _this._masked = false;\n    _this._fin = false;\n    _this._opcode = 0;\n    _this._totalPayloadLength = 0;\n    _this._messageLength = 0;\n    _this._fragments = [];\n    _this._state = GET_INFO;\n    _this._loop = false;\n    return _this;\n  }\n  /**\n   * Implements `Writable.prototype._write()`.\n   *\n   * @param {Buffer} chunk The chunk of data to write\n   * @param {String} encoding The character encoding of `chunk`\n   * @param {Function} cb Callback\n   * @private\n   */\n\n\n  _createClass(Receiver, [{\n    key: \"_write\",\n    value: function _write(chunk, encoding, cb) {\n      if (this._opcode === 0x08 && this._state == GET_INFO) return cb();\n      this._bufferedBytes += chunk.length;\n\n      this._buffers.push(chunk);\n\n      this.startLoop(cb);\n    }\n    /**\n     * Consumes `n` bytes from the buffered data.\n     *\n     * @param {Number} n The number of bytes to consume\n     * @return {Buffer} The consumed bytes\n     * @private\n     */\n\n  }, {\n    key: \"consume\",\n    value: function consume(n) {\n      this._bufferedBytes -= n;\n      if (n === this._buffers[0].length) return this._buffers.shift();\n\n      if (n < this._buffers[0].length) {\n        var buf = this._buffers[0];\n        this._buffers[0] = buf.slice(n);\n        return buf.slice(0, n);\n      }\n\n      var dst = Buffer.allocUnsafe(n);\n\n      do {\n        var _buf = this._buffers[0];\n        var offset = dst.length - n;\n\n        if (n >= _buf.length) {\n          dst.set(this._buffers.shift(), offset);\n        } else {\n          dst.set(new Uint8Array(_buf.buffer, _buf.byteOffset, n), offset);\n          this._buffers[0] = _buf.slice(n);\n        }\n\n        n -= _buf.length;\n      } while (n > 0);\n\n      return dst;\n    }\n    /**\n     * Starts the parsing loop.\n     *\n     * @param {Function} cb Callback\n     * @private\n     */\n\n  }, {\n    key: \"startLoop\",\n    value: function startLoop(cb) {\n      var err;\n      this._loop = true;\n\n      do {\n        switch (this._state) {\n          case GET_INFO:\n            err = this.getInfo();\n            break;\n\n          case GET_PAYLOAD_LENGTH_16:\n            err = this.getPayloadLength16();\n            break;\n\n          case GET_PAYLOAD_LENGTH_64:\n            err = this.getPayloadLength64();\n            break;\n\n          case GET_MASK:\n            this.getMask();\n            break;\n\n          case GET_DATA:\n            err = this.getData(cb);\n            break;\n\n          default:\n            // `INFLATING`\n            this._loop = false;\n            return;\n        }\n      } while (this._loop);\n\n      cb(err);\n    }\n    /**\n     * Reads the first two bytes of a frame.\n     *\n     * @return {(RangeError|undefined)} A possible error\n     * @private\n     */\n\n  }, {\n    key: \"getInfo\",\n    value: function getInfo() {\n      if (this._bufferedBytes < 2) {\n        this._loop = false;\n        return;\n      }\n\n      var buf = this.consume(2);\n\n      if ((buf[0] & 0x30) !== 0x00) {\n        this._loop = false;\n        return error(RangeError, 'RSV2 and RSV3 must be clear', true, 1002, 'WS_ERR_UNEXPECTED_RSV_2_3');\n      }\n\n      var compressed = (buf[0] & 0x40) === 0x40;\n\n      if (compressed && !this._extensions[PerMessageDeflate.extensionName]) {\n        this._loop = false;\n        return error(RangeError, 'RSV1 must be clear', true, 1002, 'WS_ERR_UNEXPECTED_RSV_1');\n      }\n\n      this._fin = (buf[0] & 0x80) === 0x80;\n      this._opcode = buf[0] & 0x0f;\n      this._payloadLength = buf[1] & 0x7f;\n\n      if (this._opcode === 0x00) {\n        if (compressed) {\n          this._loop = false;\n          return error(RangeError, 'RSV1 must be clear', true, 1002, 'WS_ERR_UNEXPECTED_RSV_1');\n        }\n\n        if (!this._fragmented) {\n          this._loop = false;\n          return error(RangeError, 'invalid opcode 0', true, 1002, 'WS_ERR_INVALID_OPCODE');\n        }\n\n        this._opcode = this._fragmented;\n      } else if (this._opcode === 0x01 || this._opcode === 0x02) {\n        if (this._fragmented) {\n          this._loop = false;\n          return error(RangeError, \"invalid opcode \".concat(this._opcode), true, 1002, 'WS_ERR_INVALID_OPCODE');\n        }\n\n        this._compressed = compressed;\n      } else if (this._opcode > 0x07 && this._opcode < 0x0b) {\n        if (!this._fin) {\n          this._loop = false;\n          return error(RangeError, 'FIN must be set', true, 1002, 'WS_ERR_EXPECTED_FIN');\n        }\n\n        if (compressed) {\n          this._loop = false;\n          return error(RangeError, 'RSV1 must be clear', true, 1002, 'WS_ERR_UNEXPECTED_RSV_1');\n        }\n\n        if (this._payloadLength > 0x7d) {\n          this._loop = false;\n          return error(RangeError, \"invalid payload length \".concat(this._payloadLength), true, 1002, 'WS_ERR_INVALID_CONTROL_PAYLOAD_LENGTH');\n        }\n      } else {\n        this._loop = false;\n        return error(RangeError, \"invalid opcode \".concat(this._opcode), true, 1002, 'WS_ERR_INVALID_OPCODE');\n      }\n\n      if (!this._fin && !this._fragmented) this._fragmented = this._opcode;\n      this._masked = (buf[1] & 0x80) === 0x80;\n\n      if (this._isServer) {\n        if (!this._masked) {\n          this._loop = false;\n          return error(RangeError, 'MASK must be set', true, 1002, 'WS_ERR_EXPECTED_MASK');\n        }\n      } else if (this._masked) {\n        this._loop = false;\n        return error(RangeError, 'MASK must be clear', true, 1002, 'WS_ERR_UNEXPECTED_MASK');\n      }\n\n      if (this._payloadLength === 126) this._state = GET_PAYLOAD_LENGTH_16;else if (this._payloadLength === 127) this._state = GET_PAYLOAD_LENGTH_64;else return this.haveLength();\n    }\n    /**\n     * Gets extended payload length (7+16).\n     *\n     * @return {(RangeError|undefined)} A possible error\n     * @private\n     */\n\n  }, {\n    key: \"getPayloadLength16\",\n    value: function getPayloadLength16() {\n      if (this._bufferedBytes < 2) {\n        this._loop = false;\n        return;\n      }\n\n      this._payloadLength = this.consume(2).readUInt16BE(0);\n      return this.haveLength();\n    }\n    /**\n     * Gets extended payload length (7+64).\n     *\n     * @return {(RangeError|undefined)} A possible error\n     * @private\n     */\n\n  }, {\n    key: \"getPayloadLength64\",\n    value: function getPayloadLength64() {\n      if (this._bufferedBytes < 8) {\n        this._loop = false;\n        return;\n      }\n\n      var buf = this.consume(8);\n      var num = buf.readUInt32BE(0); //\n      // The maximum safe integer in JavaScript is 2^53 - 1. An error is returned\n      // if payload length is greater than this number.\n      //\n\n      if (num > Math.pow(2, 53 - 32) - 1) {\n        this._loop = false;\n        return error(RangeError, 'Unsupported WebSocket frame: payload length > 2^53 - 1', false, 1009, 'WS_ERR_UNSUPPORTED_DATA_PAYLOAD_LENGTH');\n      }\n\n      this._payloadLength = num * Math.pow(2, 32) + buf.readUInt32BE(4);\n      return this.haveLength();\n    }\n    /**\n     * Payload length has been read.\n     *\n     * @return {(RangeError|undefined)} A possible error\n     * @private\n     */\n\n  }, {\n    key: \"haveLength\",\n    value: function haveLength() {\n      if (this._payloadLength && this._opcode < 0x08) {\n        this._totalPayloadLength += this._payloadLength;\n\n        if (this._totalPayloadLength > this._maxPayload && this._maxPayload > 0) {\n          this._loop = false;\n          return error(RangeError, 'Max payload size exceeded', false, 1009, 'WS_ERR_UNSUPPORTED_MESSAGE_LENGTH');\n        }\n      }\n\n      if (this._masked) this._state = GET_MASK;else this._state = GET_DATA;\n    }\n    /**\n     * Reads mask bytes.\n     *\n     * @private\n     */\n\n  }, {\n    key: \"getMask\",\n    value: function getMask() {\n      if (this._bufferedBytes < 4) {\n        this._loop = false;\n        return;\n      }\n\n      this._mask = this.consume(4);\n      this._state = GET_DATA;\n    }\n    /**\n     * Reads data bytes.\n     *\n     * @param {Function} cb Callback\n     * @return {(Error|RangeError|undefined)} A possible error\n     * @private\n     */\n\n  }, {\n    key: \"getData\",\n    value: function getData(cb) {\n      var data = EMPTY_BUFFER;\n\n      if (this._payloadLength) {\n        if (this._bufferedBytes < this._payloadLength) {\n          this._loop = false;\n          return;\n        }\n\n        data = this.consume(this._payloadLength);\n\n        if (this._masked && (this._mask[0] | this._mask[1] | this._mask[2] | this._mask[3]) !== 0) {\n          unmask(data, this._mask);\n        }\n      }\n\n      if (this._opcode > 0x07) return this.controlMessage(data);\n\n      if (this._compressed) {\n        this._state = INFLATING;\n        this.decompress(data, cb);\n        return;\n      }\n\n      if (data.length) {\n        //\n        // This message is not compressed so its length is the sum of the payload\n        // length of all fragments.\n        //\n        this._messageLength = this._totalPayloadLength;\n\n        this._fragments.push(data);\n      }\n\n      return this.dataMessage();\n    }\n    /**\n     * Decompresses data.\n     *\n     * @param {Buffer} data Compressed data\n     * @param {Function} cb Callback\n     * @private\n     */\n\n  }, {\n    key: \"decompress\",\n    value: function decompress(data, cb) {\n      var _this2 = this;\n\n      var perMessageDeflate = this._extensions[PerMessageDeflate.extensionName];\n      perMessageDeflate.decompress(data, this._fin, function (err, buf) {\n        if (err) return cb(err);\n\n        if (buf.length) {\n          _this2._messageLength += buf.length;\n\n          if (_this2._messageLength > _this2._maxPayload && _this2._maxPayload > 0) {\n            return cb(error(RangeError, 'Max payload size exceeded', false, 1009, 'WS_ERR_UNSUPPORTED_MESSAGE_LENGTH'));\n          }\n\n          _this2._fragments.push(buf);\n        }\n\n        var er = _this2.dataMessage();\n\n        if (er) return cb(er);\n\n        _this2.startLoop(cb);\n      });\n    }\n    /**\n     * Handles a data message.\n     *\n     * @return {(Error|undefined)} A possible error\n     * @private\n     */\n\n  }, {\n    key: \"dataMessage\",\n    value: function dataMessage() {\n      if (this._fin) {\n        var messageLength = this._messageLength;\n        var fragments = this._fragments;\n        this._totalPayloadLength = 0;\n        this._messageLength = 0;\n        this._fragmented = 0;\n        this._fragments = [];\n\n        if (this._opcode === 2) {\n          var data;\n\n          if (this._binaryType === 'nodebuffer') {\n            data = concat(fragments, messageLength);\n          } else if (this._binaryType === 'arraybuffer') {\n            data = toArrayBuffer(concat(fragments, messageLength));\n          } else {\n            data = fragments;\n          }\n\n          this.emit('message', data, true);\n        } else {\n          var buf = concat(fragments, messageLength);\n\n          if (!this._skipUTF8Validation && !isValidUTF8(buf)) {\n            this._loop = false;\n            return error(Error, 'invalid UTF-8 sequence', true, 1007, 'WS_ERR_INVALID_UTF8');\n          }\n\n          this.emit('message', buf, false);\n        }\n      }\n\n      this._state = GET_INFO;\n    }\n    /**\n     * Handles a control message.\n     *\n     * @param {Buffer} data Data to handle\n     * @return {(Error|RangeError|undefined)} A possible error\n     * @private\n     */\n\n  }, {\n    key: \"controlMessage\",\n    value: function controlMessage(data) {\n      if (this._opcode === 0x08) {\n        this._loop = false;\n\n        if (data.length === 0) {\n          this.emit('conclude', 1005, EMPTY_BUFFER);\n          this.end();\n        } else if (data.length === 1) {\n          return error(RangeError, 'invalid payload length 1', true, 1002, 'WS_ERR_INVALID_CONTROL_PAYLOAD_LENGTH');\n        } else {\n          var code = data.readUInt16BE(0);\n\n          if (!isValidStatusCode(code)) {\n            return error(RangeError, \"invalid status code \".concat(code), true, 1002, 'WS_ERR_INVALID_CLOSE_CODE');\n          }\n\n          var buf = data.slice(2);\n\n          if (!this._skipUTF8Validation && !isValidUTF8(buf)) {\n            return error(Error, 'invalid UTF-8 sequence', true, 1007, 'WS_ERR_INVALID_UTF8');\n          }\n\n          this.emit('conclude', code, buf);\n          this.end();\n        }\n      } else if (this._opcode === 0x09) {\n        this.emit('ping', data);\n      } else {\n        this.emit('pong', data);\n      }\n\n      this._state = GET_INFO;\n    }\n  }]);\n\n  return Receiver;\n}(Writable);\n\nmodule.exports = Receiver;\n/**\n * Builds an error object.\n *\n * @param {function(new:Error|RangeError)} ErrorCtor The error constructor\n * @param {String} message The error message\n * @param {Boolean} prefix Specifies whether or not to add a default prefix to\n *     `message`\n * @param {Number} statusCode The status code\n * @param {String} errorCode The exposed error code\n * @return {(Error|RangeError)} The error\n * @private\n */\n\nfunction error(ErrorCtor, message, prefix, statusCode, errorCode) {\n  var err = new ErrorCtor(prefix ? \"Invalid WebSocket frame: \".concat(message) : message);\n  Error.captureStackTrace(err, error);\n  err.code = errorCode;\n  err[kStatusCode] = statusCode;\n  return err;\n}","map":{"version":3,"sources":["E:/DW/wasai-cinema/node_modules/webpack-dev-server/node_modules/ws/lib/receiver.js"],"names":["require","Writable","PerMessageDeflate","BINARY_TYPES","EMPTY_BUFFER","kStatusCode","kWebSocket","concat","toArrayBuffer","unmask","isValidStatusCode","isValidUTF8","GET_INFO","GET_PAYLOAD_LENGTH_16","GET_PAYLOAD_LENGTH_64","GET_MASK","GET_DATA","INFLATING","Receiver","options","_binaryType","binaryType","_extensions","extensions","_isServer","isServer","_maxPayload","maxPayload","_skipUTF8Validation","skipUTF8Validation","undefined","_bufferedBytes","_buffers","_compressed","_payloadLength","_mask","_fragmented","_masked","_fin","_opcode","_totalPayloadLength","_messageLength","_fragments","_state","_loop","chunk","encoding","cb","length","push","startLoop","n","shift","buf","slice","dst","Buffer","allocUnsafe","offset","set","Uint8Array","buffer","byteOffset","err","getInfo","getPayloadLength16","getPayloadLength64","getMask","getData","consume","error","RangeError","compressed","extensionName","haveLength","readUInt16BE","num","readUInt32BE","Math","pow","data","controlMessage","decompress","dataMessage","perMessageDeflate","er","messageLength","fragments","emit","Error","end","code","module","exports","ErrorCtor","message","prefix","statusCode","errorCode","captureStackTrace"],"mappings":"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","sourcesContent":["'use strict';\n\nconst { Writable } = require('stream');\n\nconst PerMessageDeflate = require('./permessage-deflate');\nconst {\n  BINARY_TYPES,\n  EMPTY_BUFFER,\n  kStatusCode,\n  kWebSocket\n} = require('./constants');\nconst { concat, toArrayBuffer, unmask } = require('./buffer-util');\nconst { isValidStatusCode, isValidUTF8 } = require('./validation');\n\nconst GET_INFO = 0;\nconst GET_PAYLOAD_LENGTH_16 = 1;\nconst GET_PAYLOAD_LENGTH_64 = 2;\nconst GET_MASK = 3;\nconst GET_DATA = 4;\nconst INFLATING = 5;\n\n/**\n * HyBi Receiver implementation.\n *\n * @extends Writable\n */\nclass Receiver extends Writable {\n  /**\n   * Creates a Receiver instance.\n   *\n   * @param {Object} [options] Options object\n   * @param {String} [options.binaryType=nodebuffer] The type for binary data\n   * @param {Object} [options.extensions] An object containing the negotiated\n   *     extensions\n   * @param {Boolean} [options.isServer=false] Specifies whether to operate in\n   *     client or server mode\n   * @param {Number} [options.maxPayload=0] The maximum allowed message length\n   * @param {Boolean} [options.skipUTF8Validation=false] Specifies whether or\n   *     not to skip UTF-8 validation for text and close messages\n   */\n  constructor(options = {}) {\n    super();\n\n    this._binaryType = options.binaryType || BINARY_TYPES[0];\n    this._extensions = options.extensions || {};\n    this._isServer = !!options.isServer;\n    this._maxPayload = options.maxPayload | 0;\n    this._skipUTF8Validation = !!options.skipUTF8Validation;\n    this[kWebSocket] = undefined;\n\n    this._bufferedBytes = 0;\n    this._buffers = [];\n\n    this._compressed = false;\n    this._payloadLength = 0;\n    this._mask = undefined;\n    this._fragmented = 0;\n    this._masked = false;\n    this._fin = false;\n    this._opcode = 0;\n\n    this._totalPayloadLength = 0;\n    this._messageLength = 0;\n    this._fragments = [];\n\n    this._state = GET_INFO;\n    this._loop = false;\n  }\n\n  /**\n   * Implements `Writable.prototype._write()`.\n   *\n   * @param {Buffer} chunk The chunk of data to write\n   * @param {String} encoding The character encoding of `chunk`\n   * @param {Function} cb Callback\n   * @private\n   */\n  _write(chunk, encoding, cb) {\n    if (this._opcode === 0x08 && this._state == GET_INFO) return cb();\n\n    this._bufferedBytes += chunk.length;\n    this._buffers.push(chunk);\n    this.startLoop(cb);\n  }\n\n  /**\n   * Consumes `n` bytes from the buffered data.\n   *\n   * @param {Number} n The number of bytes to consume\n   * @return {Buffer} The consumed bytes\n   * @private\n   */\n  consume(n) {\n    this._bufferedBytes -= n;\n\n    if (n === this._buffers[0].length) return this._buffers.shift();\n\n    if (n < this._buffers[0].length) {\n      const buf = this._buffers[0];\n      this._buffers[0] = buf.slice(n);\n      return buf.slice(0, n);\n    }\n\n    const dst = Buffer.allocUnsafe(n);\n\n    do {\n      const buf = this._buffers[0];\n      const offset = dst.length - n;\n\n      if (n >= buf.length) {\n        dst.set(this._buffers.shift(), offset);\n      } else {\n        dst.set(new Uint8Array(buf.buffer, buf.byteOffset, n), offset);\n        this._buffers[0] = buf.slice(n);\n      }\n\n      n -= buf.length;\n    } while (n > 0);\n\n    return dst;\n  }\n\n  /**\n   * Starts the parsing loop.\n   *\n   * @param {Function} cb Callback\n   * @private\n   */\n  startLoop(cb) {\n    let err;\n    this._loop = true;\n\n    do {\n      switch (this._state) {\n        case GET_INFO:\n          err = this.getInfo();\n          break;\n        case GET_PAYLOAD_LENGTH_16:\n          err = this.getPayloadLength16();\n          break;\n        case GET_PAYLOAD_LENGTH_64:\n          err = this.getPayloadLength64();\n          break;\n        case GET_MASK:\n          this.getMask();\n          break;\n        case GET_DATA:\n          err = this.getData(cb);\n          break;\n        default:\n          // `INFLATING`\n          this._loop = false;\n          return;\n      }\n    } while (this._loop);\n\n    cb(err);\n  }\n\n  /**\n   * Reads the first two bytes of a frame.\n   *\n   * @return {(RangeError|undefined)} A possible error\n   * @private\n   */\n  getInfo() {\n    if (this._bufferedBytes < 2) {\n      this._loop = false;\n      return;\n    }\n\n    const buf = this.consume(2);\n\n    if ((buf[0] & 0x30) !== 0x00) {\n      this._loop = false;\n      return error(\n        RangeError,\n        'RSV2 and RSV3 must be clear',\n        true,\n        1002,\n        'WS_ERR_UNEXPECTED_RSV_2_3'\n      );\n    }\n\n    const compressed = (buf[0] & 0x40) === 0x40;\n\n    if (compressed && !this._extensions[PerMessageDeflate.extensionName]) {\n      this._loop = false;\n      return error(\n        RangeError,\n        'RSV1 must be clear',\n        true,\n        1002,\n        'WS_ERR_UNEXPECTED_RSV_1'\n      );\n    }\n\n    this._fin = (buf[0] & 0x80) === 0x80;\n    this._opcode = buf[0] & 0x0f;\n    this._payloadLength = buf[1] & 0x7f;\n\n    if (this._opcode === 0x00) {\n      if (compressed) {\n        this._loop = false;\n        return error(\n          RangeError,\n          'RSV1 must be clear',\n          true,\n          1002,\n          'WS_ERR_UNEXPECTED_RSV_1'\n        );\n      }\n\n      if (!this._fragmented) {\n        this._loop = false;\n        return error(\n          RangeError,\n          'invalid opcode 0',\n          true,\n          1002,\n          'WS_ERR_INVALID_OPCODE'\n        );\n      }\n\n      this._opcode = this._fragmented;\n    } else if (this._opcode === 0x01 || this._opcode === 0x02) {\n      if (this._fragmented) {\n        this._loop = false;\n        return error(\n          RangeError,\n          `invalid opcode ${this._opcode}`,\n          true,\n          1002,\n          'WS_ERR_INVALID_OPCODE'\n        );\n      }\n\n      this._compressed = compressed;\n    } else if (this._opcode > 0x07 && this._opcode < 0x0b) {\n      if (!this._fin) {\n        this._loop = false;\n        return error(\n          RangeError,\n          'FIN must be set',\n          true,\n          1002,\n          'WS_ERR_EXPECTED_FIN'\n        );\n      }\n\n      if (compressed) {\n        this._loop = false;\n        return error(\n          RangeError,\n          'RSV1 must be clear',\n          true,\n          1002,\n          'WS_ERR_UNEXPECTED_RSV_1'\n        );\n      }\n\n      if (this._payloadLength > 0x7d) {\n        this._loop = false;\n        return error(\n          RangeError,\n          `invalid payload length ${this._payloadLength}`,\n          true,\n          1002,\n          'WS_ERR_INVALID_CONTROL_PAYLOAD_LENGTH'\n        );\n      }\n    } else {\n      this._loop = false;\n      return error(\n        RangeError,\n        `invalid opcode ${this._opcode}`,\n        true,\n        1002,\n        'WS_ERR_INVALID_OPCODE'\n      );\n    }\n\n    if (!this._fin && !this._fragmented) this._fragmented = this._opcode;\n    this._masked = (buf[1] & 0x80) === 0x80;\n\n    if (this._isServer) {\n      if (!this._masked) {\n        this._loop = false;\n        return error(\n          RangeError,\n          'MASK must be set',\n          true,\n          1002,\n          'WS_ERR_EXPECTED_MASK'\n        );\n      }\n    } else if (this._masked) {\n      this._loop = false;\n      return error(\n        RangeError,\n        'MASK must be clear',\n        true,\n        1002,\n        'WS_ERR_UNEXPECTED_MASK'\n      );\n    }\n\n    if (this._payloadLength === 126) this._state = GET_PAYLOAD_LENGTH_16;\n    else if (this._payloadLength === 127) this._state = GET_PAYLOAD_LENGTH_64;\n    else return this.haveLength();\n  }\n\n  /**\n   * Gets extended payload length (7+16).\n   *\n   * @return {(RangeError|undefined)} A possible error\n   * @private\n   */\n  getPayloadLength16() {\n    if (this._bufferedBytes < 2) {\n      this._loop = false;\n      return;\n    }\n\n    this._payloadLength = this.consume(2).readUInt16BE(0);\n    return this.haveLength();\n  }\n\n  /**\n   * Gets extended payload length (7+64).\n   *\n   * @return {(RangeError|undefined)} A possible error\n   * @private\n   */\n  getPayloadLength64() {\n    if (this._bufferedBytes < 8) {\n      this._loop = false;\n      return;\n    }\n\n    const buf = this.consume(8);\n    const num = buf.readUInt32BE(0);\n\n    //\n    // The maximum safe integer in JavaScript is 2^53 - 1. An error is returned\n    // if payload length is greater than this number.\n    //\n    if (num > Math.pow(2, 53 - 32) - 1) {\n      this._loop = false;\n      return error(\n        RangeError,\n        'Unsupported WebSocket frame: payload length > 2^53 - 1',\n        false,\n        1009,\n        'WS_ERR_UNSUPPORTED_DATA_PAYLOAD_LENGTH'\n      );\n    }\n\n    this._payloadLength = num * Math.pow(2, 32) + buf.readUInt32BE(4);\n    return this.haveLength();\n  }\n\n  /**\n   * Payload length has been read.\n   *\n   * @return {(RangeError|undefined)} A possible error\n   * @private\n   */\n  haveLength() {\n    if (this._payloadLength && this._opcode < 0x08) {\n      this._totalPayloadLength += this._payloadLength;\n      if (this._totalPayloadLength > this._maxPayload && this._maxPayload > 0) {\n        this._loop = false;\n        return error(\n          RangeError,\n          'Max payload size exceeded',\n          false,\n          1009,\n          'WS_ERR_UNSUPPORTED_MESSAGE_LENGTH'\n        );\n      }\n    }\n\n    if (this._masked) this._state = GET_MASK;\n    else this._state = GET_DATA;\n  }\n\n  /**\n   * Reads mask bytes.\n   *\n   * @private\n   */\n  getMask() {\n    if (this._bufferedBytes < 4) {\n      this._loop = false;\n      return;\n    }\n\n    this._mask = this.consume(4);\n    this._state = GET_DATA;\n  }\n\n  /**\n   * Reads data bytes.\n   *\n   * @param {Function} cb Callback\n   * @return {(Error|RangeError|undefined)} A possible error\n   * @private\n   */\n  getData(cb) {\n    let data = EMPTY_BUFFER;\n\n    if (this._payloadLength) {\n      if (this._bufferedBytes < this._payloadLength) {\n        this._loop = false;\n        return;\n      }\n\n      data = this.consume(this._payloadLength);\n\n      if (\n        this._masked &&\n        (this._mask[0] | this._mask[1] | this._mask[2] | this._mask[3]) !== 0\n      ) {\n        unmask(data, this._mask);\n      }\n    }\n\n    if (this._opcode > 0x07) return this.controlMessage(data);\n\n    if (this._compressed) {\n      this._state = INFLATING;\n      this.decompress(data, cb);\n      return;\n    }\n\n    if (data.length) {\n      //\n      // This message is not compressed so its length is the sum of the payload\n      // length of all fragments.\n      //\n      this._messageLength = this._totalPayloadLength;\n      this._fragments.push(data);\n    }\n\n    return this.dataMessage();\n  }\n\n  /**\n   * Decompresses data.\n   *\n   * @param {Buffer} data Compressed data\n   * @param {Function} cb Callback\n   * @private\n   */\n  decompress(data, cb) {\n    const perMessageDeflate = this._extensions[PerMessageDeflate.extensionName];\n\n    perMessageDeflate.decompress(data, this._fin, (err, buf) => {\n      if (err) return cb(err);\n\n      if (buf.length) {\n        this._messageLength += buf.length;\n        if (this._messageLength > this._maxPayload && this._maxPayload > 0) {\n          return cb(\n            error(\n              RangeError,\n              'Max payload size exceeded',\n              false,\n              1009,\n              'WS_ERR_UNSUPPORTED_MESSAGE_LENGTH'\n            )\n          );\n        }\n\n        this._fragments.push(buf);\n      }\n\n      const er = this.dataMessage();\n      if (er) return cb(er);\n\n      this.startLoop(cb);\n    });\n  }\n\n  /**\n   * Handles a data message.\n   *\n   * @return {(Error|undefined)} A possible error\n   * @private\n   */\n  dataMessage() {\n    if (this._fin) {\n      const messageLength = this._messageLength;\n      const fragments = this._fragments;\n\n      this._totalPayloadLength = 0;\n      this._messageLength = 0;\n      this._fragmented = 0;\n      this._fragments = [];\n\n      if (this._opcode === 2) {\n        let data;\n\n        if (this._binaryType === 'nodebuffer') {\n          data = concat(fragments, messageLength);\n        } else if (this._binaryType === 'arraybuffer') {\n          data = toArrayBuffer(concat(fragments, messageLength));\n        } else {\n          data = fragments;\n        }\n\n        this.emit('message', data, true);\n      } else {\n        const buf = concat(fragments, messageLength);\n\n        if (!this._skipUTF8Validation && !isValidUTF8(buf)) {\n          this._loop = false;\n          return error(\n            Error,\n            'invalid UTF-8 sequence',\n            true,\n            1007,\n            'WS_ERR_INVALID_UTF8'\n          );\n        }\n\n        this.emit('message', buf, false);\n      }\n    }\n\n    this._state = GET_INFO;\n  }\n\n  /**\n   * Handles a control message.\n   *\n   * @param {Buffer} data Data to handle\n   * @return {(Error|RangeError|undefined)} A possible error\n   * @private\n   */\n  controlMessage(data) {\n    if (this._opcode === 0x08) {\n      this._loop = false;\n\n      if (data.length === 0) {\n        this.emit('conclude', 1005, EMPTY_BUFFER);\n        this.end();\n      } else if (data.length === 1) {\n        return error(\n          RangeError,\n          'invalid payload length 1',\n          true,\n          1002,\n          'WS_ERR_INVALID_CONTROL_PAYLOAD_LENGTH'\n        );\n      } else {\n        const code = data.readUInt16BE(0);\n\n        if (!isValidStatusCode(code)) {\n          return error(\n            RangeError,\n            `invalid status code ${code}`,\n            true,\n            1002,\n            'WS_ERR_INVALID_CLOSE_CODE'\n          );\n        }\n\n        const buf = data.slice(2);\n\n        if (!this._skipUTF8Validation && !isValidUTF8(buf)) {\n          return error(\n            Error,\n            'invalid UTF-8 sequence',\n            true,\n            1007,\n            'WS_ERR_INVALID_UTF8'\n          );\n        }\n\n        this.emit('conclude', code, buf);\n        this.end();\n      }\n    } else if (this._opcode === 0x09) {\n      this.emit('ping', data);\n    } else {\n      this.emit('pong', data);\n    }\n\n    this._state = GET_INFO;\n  }\n}\n\nmodule.exports = Receiver;\n\n/**\n * Builds an error object.\n *\n * @param {function(new:Error|RangeError)} ErrorCtor The error constructor\n * @param {String} message The error message\n * @param {Boolean} prefix Specifies whether or not to add a default prefix to\n *     `message`\n * @param {Number} statusCode The status code\n * @param {String} errorCode The exposed error code\n * @return {(Error|RangeError)} The error\n * @private\n */\nfunction error(ErrorCtor, message, prefix, statusCode, errorCode) {\n  const err = new ErrorCtor(\n    prefix ? `Invalid WebSocket frame: ${message}` : message\n  );\n\n  Error.captureStackTrace(err, error);\n  err.code = errorCode;\n  err[kStatusCode] = statusCode;\n  return err;\n}\n"]},"metadata":{},"sourceType":"script"}