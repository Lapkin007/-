{"ast":null,"code":"\"use strict\";\n\nvar _objectSpread = require(\"E:/DW/wasai-cinema/node_modules/@babel/runtime/helpers/objectSpread2.js\").default;\n\nvar _taggedTemplateLiteral = require(\"E:/DW/wasai-cinema/node_modules/@babel/runtime/helpers/taggedTemplateLiteral.js\").default;\n\nvar _createClass = require(\"E:/DW/wasai-cinema/node_modules/@babel/runtime/helpers/createClass.js\").default;\n\nvar _classCallCheck = require(\"E:/DW/wasai-cinema/node_modules/@babel/runtime/helpers/classCallCheck.js\").default;\n\nvar _inherits = require(\"E:/DW/wasai-cinema/node_modules/@babel/runtime/helpers/inherits.js\").default;\n\nvar _createSuper = require(\"E:/DW/wasai-cinema/node_modules/@babel/runtime/helpers/createSuper.js\").default;\n\nvar _wrapNativeSuper = require(\"E:/DW/wasai-cinema/node_modules/@babel/runtime/helpers/wrapNativeSuper.js\").default;\n\nvar _templateObject, _templateObject2, _templateObject3, _templateObject4, _templateObject5;\n\nrequire(\"core-js/modules/es.error.cause.js\");\n\nrequire(\"core-js/modules/es.function.name.js\");\n\nrequire(\"core-js/modules/es.array.concat.js\");\n\nrequire(\"core-js/modules/es.map.js\");\n\nrequire(\"core-js/modules/es.object.to-string.js\");\n\nrequire(\"core-js/modules/es.string.iterator.js\");\n\nrequire(\"core-js/modules/web.dom-collections.iterator.js\");\n\nrequire(\"core-js/modules/web.dom-collections.for-each.js\");\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.ValueScope = exports.ValueScopeName = exports.Scope = exports.varKinds = exports.UsedValueState = void 0;\n\nvar code_1 = require(\"./code\");\n\nvar ValueError = /*#__PURE__*/function (_Error) {\n  _inherits(ValueError, _Error);\n\n  var _super = _createSuper(ValueError);\n\n  function ValueError(name) {\n    var _this;\n\n    _classCallCheck(this, ValueError);\n\n    _this = _super.call(this, \"CodeGen: \\\"code\\\" for \".concat(name, \" not defined\"));\n    _this.value = name.value;\n    return _this;\n  }\n\n  return _createClass(ValueError);\n}( /*#__PURE__*/_wrapNativeSuper(Error));\n\nvar UsedValueState;\n\n(function (UsedValueState) {\n  UsedValueState[UsedValueState[\"Started\"] = 0] = \"Started\";\n  UsedValueState[UsedValueState[\"Completed\"] = 1] = \"Completed\";\n})(UsedValueState = exports.UsedValueState || (exports.UsedValueState = {}));\n\nexports.varKinds = {\n  const: new code_1.Name(\"const\"),\n  let: new code_1.Name(\"let\"),\n  var: new code_1.Name(\"var\")\n};\n\nvar Scope = /*#__PURE__*/function () {\n  function Scope() {\n    var _ref = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {},\n        prefixes = _ref.prefixes,\n        parent = _ref.parent;\n\n    _classCallCheck(this, Scope);\n\n    this._names = {};\n    this._prefixes = prefixes;\n    this._parent = parent;\n  }\n\n  _createClass(Scope, [{\n    key: \"toName\",\n    value: function toName(nameOrPrefix) {\n      return nameOrPrefix instanceof code_1.Name ? nameOrPrefix : this.name(nameOrPrefix);\n    }\n  }, {\n    key: \"name\",\n    value: function name(prefix) {\n      return new code_1.Name(this._newName(prefix));\n    }\n  }, {\n    key: \"_newName\",\n    value: function _newName(prefix) {\n      var ng = this._names[prefix] || this._nameGroup(prefix);\n\n      return \"\".concat(prefix).concat(ng.index++);\n    }\n  }, {\n    key: \"_nameGroup\",\n    value: function _nameGroup(prefix) {\n      var _a, _b;\n\n      if (((_b = (_a = this._parent) === null || _a === void 0 ? void 0 : _a._prefixes) === null || _b === void 0 ? void 0 : _b.has(prefix)) || this._prefixes && !this._prefixes.has(prefix)) {\n        throw new Error(\"CodeGen: prefix \\\"\".concat(prefix, \"\\\" is not allowed in this scope\"));\n      }\n\n      return this._names[prefix] = {\n        prefix: prefix,\n        index: 0\n      };\n    }\n  }]);\n\n  return Scope;\n}();\n\nexports.Scope = Scope;\n\nvar ValueScopeName = /*#__PURE__*/function (_code_1$Name) {\n  _inherits(ValueScopeName, _code_1$Name);\n\n  var _super2 = _createSuper(ValueScopeName);\n\n  function ValueScopeName(prefix, nameStr) {\n    var _this2;\n\n    _classCallCheck(this, ValueScopeName);\n\n    _this2 = _super2.call(this, nameStr);\n    _this2.prefix = prefix;\n    return _this2;\n  }\n\n  _createClass(ValueScopeName, [{\n    key: \"setValue\",\n    value: function setValue(value, _ref2) {\n      var property = _ref2.property,\n          itemIndex = _ref2.itemIndex;\n      this.value = value;\n      this.scopePath = (0, code_1._)(_templateObject || (_templateObject = _taggedTemplateLiteral([\".\", \"[\", \"]\"])), new code_1.Name(property), itemIndex);\n    }\n  }]);\n\n  return ValueScopeName;\n}(code_1.Name);\n\nexports.ValueScopeName = ValueScopeName;\nvar line = (0, code_1._)(_templateObject2 || (_templateObject2 = _taggedTemplateLiteral([\"\\n\"], [\"\\\\n\"])));\n\nvar ValueScope = /*#__PURE__*/function (_Scope) {\n  _inherits(ValueScope, _Scope);\n\n  var _super3 = _createSuper(ValueScope);\n\n  function ValueScope(opts) {\n    var _this3;\n\n    _classCallCheck(this, ValueScope);\n\n    _this3 = _super3.call(this, opts);\n    _this3._values = {};\n    _this3._scope = opts.scope;\n    _this3.opts = _objectSpread(_objectSpread({}, opts), {}, {\n      _n: opts.lines ? line : code_1.nil\n    });\n    return _this3;\n  }\n\n  _createClass(ValueScope, [{\n    key: \"get\",\n    value: function get() {\n      return this._scope;\n    }\n  }, {\n    key: \"name\",\n    value: function name(prefix) {\n      return new ValueScopeName(prefix, this._newName(prefix));\n    }\n  }, {\n    key: \"value\",\n    value: function value(nameOrPrefix, _value) {\n      var _a;\n\n      if (_value.ref === undefined) throw new Error(\"CodeGen: ref must be passed in value\");\n      var name = this.toName(nameOrPrefix);\n      var prefix = name.prefix;\n      var valueKey = (_a = _value.key) !== null && _a !== void 0 ? _a : _value.ref;\n      var vs = this._values[prefix];\n\n      if (vs) {\n        var _name = vs.get(valueKey);\n\n        if (_name) return _name;\n      } else {\n        vs = this._values[prefix] = new Map();\n      }\n\n      vs.set(valueKey, name);\n      var s = this._scope[prefix] || (this._scope[prefix] = []);\n      var itemIndex = s.length;\n      s[itemIndex] = _value.ref;\n      name.setValue(_value, {\n        property: prefix,\n        itemIndex: itemIndex\n      });\n      return name;\n    }\n  }, {\n    key: \"getValue\",\n    value: function getValue(prefix, keyOrRef) {\n      var vs = this._values[prefix];\n      if (!vs) return;\n      return vs.get(keyOrRef);\n    }\n  }, {\n    key: \"scopeRefs\",\n    value: function scopeRefs(scopeName) {\n      var values = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : this._values;\n      return this._reduceValues(values, function (name) {\n        if (name.scopePath === undefined) throw new Error(\"CodeGen: name \\\"\".concat(name, \"\\\" has no value\"));\n        return (0, code_1._)(_templateObject3 || (_templateObject3 = _taggedTemplateLiteral([\"\", \"\", \"\"])), scopeName, name.scopePath);\n      });\n    }\n  }, {\n    key: \"scopeCode\",\n    value: function scopeCode() {\n      var values = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : this._values;\n      var usedValues = arguments.length > 1 ? arguments[1] : undefined;\n      var getCode = arguments.length > 2 ? arguments[2] : undefined;\n      return this._reduceValues(values, function (name) {\n        if (name.value === undefined) throw new Error(\"CodeGen: name \\\"\".concat(name, \"\\\" has no value\"));\n        return name.value.code;\n      }, usedValues, getCode);\n    }\n  }, {\n    key: \"_reduceValues\",\n    value: function _reduceValues(values, valueCode) {\n      var _this4 = this;\n\n      var usedValues = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : {};\n      var getCode = arguments.length > 3 ? arguments[3] : undefined;\n      var code = code_1.nil;\n\n      var _loop = function _loop(prefix) {\n        var vs = values[prefix];\n        if (!vs) return \"continue\";\n        var nameSet = usedValues[prefix] = usedValues[prefix] || new Map();\n        vs.forEach(function (name) {\n          if (nameSet.has(name)) return;\n          nameSet.set(name, UsedValueState.Started);\n          var c = valueCode(name);\n\n          if (c) {\n            var def = _this4.opts.es5 ? exports.varKinds.var : exports.varKinds.const;\n            code = (0, code_1._)(_templateObject4 || (_templateObject4 = _taggedTemplateLiteral([\"\", \"\", \" \", \" = \", \";\", \"\"])), code, def, name, c, _this4.opts._n);\n          } else if (c = getCode === null || getCode === void 0 ? void 0 : getCode(name)) {\n            code = (0, code_1._)(_templateObject5 || (_templateObject5 = _taggedTemplateLiteral([\"\", \"\", \"\", \"\"])), code, c, _this4.opts._n);\n          } else {\n            throw new ValueError(name);\n          }\n\n          nameSet.set(name, UsedValueState.Completed);\n        });\n      };\n\n      for (var prefix in values) {\n        var _ret = _loop(prefix);\n\n        if (_ret === \"continue\") continue;\n      }\n\n      return code;\n    }\n  }]);\n\n  return ValueScope;\n}(Scope);\n\nexports.ValueScope = ValueScope;","map":{"version":3,"mappings":"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","names":["ValueError","name","value","Error","UsedValueState","exports","const","code_1","let","var","Scope","prefixes","parent","_prefixes","_parent","nameOrPrefix","prefix","_newName","ng","_names","_nameGroup","index","_a","_b","has","ValueScopeName","nameStr","property","itemIndex","scopePath","line","ValueScope","opts","_scope","scope","_n","lines","ref","undefined","toName","valueKey","key","vs","_values","_name","get","Map","set","s","length","setValue","keyOrRef","scopeName","values","_reduceValues","usedValues","getCode","code","valueCode","nameSet","forEach","Started","c","def","es5","Completed"],"sourceRoot":"","sources":["../../../lib/compile/codegen/scope.ts"],"sourcesContent":[null]},"metadata":{},"sourceType":"script"}